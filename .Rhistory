epa %>% filter(uid %in% c("220759000", "400719010"))
year <- 2015
epa <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
epa %>% filter(uid %in% c("220759000", "400719010"))
year <- 2010
epa <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
epa %>% filter(uid %in% c("220759000", "400719010"))
year <- 2000
epa <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
epa %>% filter(uid %in% c("220759000", "400719010"))
improve_clean %>% group_by(EPACode) %>% summarise(n=n_distinct(SiteCode)) %>% arrange(-n)
site_identify <- improve_clean %>% group_by(EPACode) %>% summarise(n=n_distinct(SiteCode)) %>% filter(n > 1)
View(site_identify)
site_identify <- (improve_clean %>% group_by(EPACode) %>%
summarise(n=n_distinct(SiteCode)) %>% filter(n > 1))$EPACode
site_identify
site_identify <- (improve_clean %>% group_by(EPACode) %>%
summarise(n=n_distinct(SiteCode)) %>% filter(n > 1, !is.na(EPACode)))$EPACode
site_identify
improve_clean$uid <- ""
improve_clean$uid[is.na(improve_clean$EPACode)] <- improve_clean$SiteCode
improve_clean$uid <- ""
improve_clean$uid[is.na(improve_clean$EPACode)] <- improve_clean$SiteCode[is.na(improve_clean$EPACode)]
View(improve_clean)
improve_clean$uid[improve_clean$EPACode %in% site_identify] <- improve_clean$SiteCode[improve_clean$EPACode %in% site_identify]
improve_clean$uid <- improve_clean$EPACode
improve_clean$uid[is.na(improve_clean$EPACode)] <- improve_clean$SiteCode[is.na(improve_clean$EPACode)]
improve_clean$uid[improve_clean$EPACode %in% site_identify] <- improve_clean$SiteCode[improve_clean$EPACode %in% site_identify]
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
# Read in Improve and clean
improve <- read.delim("improve_data/improve_all.txt", sep = ",", header = TRUE, stringsAsFactors = FALSE)
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
# Read in Improve and clean
improve <- read.delim("improve_data/improve_all.txt", sep = ",", header = TRUE, stringsAsFactors = FALSE)
improve <- read.delim("improve_data/improve_all.txt", sep = ",", header = TRUE,
colClasses = rep("character", ncol(improve)), na.strings = c("-999", "NA"))
improve$POC <- as.numeric(improve$POC)
improve$Date <- as.Date(improve$Date, "%Y/%m/%d")
improve$Latitude <- as.numeric(improve$Latitude)
improve$Longitude <- as.numeric(improve$Longitude)
improve$MF.Value <- as.numeric(improve$MF.Value)
improve_clean <- improve %>% filter(POC == 1) %>%
filter(Date > ymd("1999-12-31"), Date < ymd("2017-01-01")) %>%
rename(pm25_obs = MF.Value) %>%
filter(!is.na(pm25_obs))
if(!(nrow(improve_clean %>% select(SiteCode, Date) %>% unique())==nrow(improve_clean))){
print("Error: Not duduped")
}
site_identify <- (improve_clean %>% group_by(EPACode) %>%
summarise(n=n_distinct(SiteCode)) %>% filter(n > 1, !is.na(EPACode)))$EPACode
improve_clean$uid <- improve_clean$EPACode
improve_clean$uid[is.na(improve_clean$EPACode)] <- improve_clean$SiteCode[is.na(improve_clean$EPACode)]
improve_clean$uid[improve_clean$EPACode %in% site_identify] <- improve_clean$SiteCode[improve_clean$EPACode %in% site_identify]
uid <- improve_clean %>% select(uid, SiteCode, EPACode)
uid <- improve_clean %>% select(uid, SiteCode, EPACode) %>% unique()
View(uid)
View(uid %>% filter(uid==SiteCode))
View(uid %>% filter(uid==EPACode))
View(uid %>% filter(uid==EPACode | uid==SiteCode))
View(uid %>% filter(!(uid==EPACode | uid==SiteCode)))
saveRDS(improve_clean, file="improve_data/improve_clean.rds")
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
# Read in Improve and clean
improve <- read.delim("improve_data/improve_all.txt", sep = ",", header = TRUE, stringsAsFactors = FALSE)
improve <- read.delim("improve_data/improve_all.txt", sep = ",", header = TRUE,
colClasses = rep("character", ncol(improve)), na.strings = c("-999", "NA"))
improve$POC <- as.numeric(improve$POC)
improve$Date <- as.Date(improve$Date, "%Y/%m/%d")
improve$Latitude <- as.numeric(improve$Latitude)
improve$Longitude <- as.numeric(improve$Longitude)
improve$MF.Value <- as.numeric(improve$MF.Value)
improve_clean <- improve %>% filter(POC == 1) %>%
filter(Date > ymd("1999-12-31"), Date < ymd("2017-01-01")) %>%
rename(pm25_obs = MF.Value) %>%
filter(!is.na(pm25_obs))
if(!(nrow(improve_clean %>% select(SiteCode, Date) %>% unique())==nrow(improve_clean))){
print("Error: Not duduped")
}
site_identify <- (improve_clean %>% group_by(EPACode) %>%
summarise(n=n_distinct(SiteCode)) %>% filter(n > 1, !is.na(EPACode)))$EPACode
improve_clean$uid <- improve_clean$EPACode
improve_clean$uid[is.na(improve_clean$EPACode)] <- improve_clean$SiteCode[is.na(improve_clean$EPACode)]
improve_clean$uid[improve_clean$EPACode %in% site_identify] <- improve_clean$SiteCode[improve_clean$EPACode %in% site_identify]
saveRDS(improve_clean, file="improve_data/improve_clean.rds")
# Read in Improve and clean
improve <- readRDS("improve_data/improve_clean.rds")
# Combine one year
year <- 2016
epa <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
# Read in Improve and clean
improve <- readRDS("improve_data/improve_clean.rds")
# Combine one year
year <- 2016
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve$Date[1]
year(improve$Date[1])
improve_year <- improve %>% filter(year(Date) == year)
range(improve_year$Date)
epa_year <- epa_year %>% select(source, uid, State.Code, County.Code, Site.Num, Latitude, Longitude, Date, pm25_obs)
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
# Read in Improve and clean
improve <- readRDS("improve_data/improve_clean.rds")
# Combine one year
year <- 2016
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year_data %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data, c("uid"="uid", "Date"="Date"))
View(combined_data)
?full_join
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
View(combined_data)
visna(combined_data)
View(combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))
nrow(combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))
1000/100000
nrow(combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve), pm25_obs_epa==pm25_obs_improve))
nrow(combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve), pm25_obs_epa-pm25_obs_improve<0.1))
nrow(combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve), pm25_obs_epa-pm25_obs_improve<0.01))
View(combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve), pm25_obs_epa-pm25_obs_improve<0.01))
View(combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve), abs(pm25_obs_epa-pm25_obs_improve)<0.1))
unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)
length(unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) / length(unique(combined_data$uid))
e year
year <- 2015
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
length(unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) / length(unique(combined_data$uid))
e year
year <- 2001
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
length(unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) / length(unique(combined_data$uid))
year <- 2016
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
length(unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) / length(unique(combined_data$uid))
unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid
unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)
View(epa_year %>% filter(uid %in% unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid))
)
View(epa_year %>% filter(uid %in% unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) %>%
select(uid, Latitude, Longitude))
View(improve_year %>% filter(uid %in% unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) %>%
select(uid, Latitude, Longitude))
View(epa_year %>% filter(uid %in% unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) %>%
select(uid, Latitude, Longitude) %>% arrange(uid))
View(improve_year %>% filter(uid %in% unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) %>%
select(uid, Latitude, Longitude) %>% arrange(uid))
View(epa_year %>% filter(uid %in% unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) %>%
select(uid, Latitude, Longitude) %>% unique() %>% arrange(uid))
View(improve_year %>% filter(uid %in% unique((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)))$uid)) %>%
select(uid, Latitude, Longitude) %>% unique() %>% arrange(uid))
quantile((combined_data %>% filter(!is.na(pm25_obs_epa), !is.na(pm25_obs_improve)) %>%
mutate(diff = pm25_obs_epa - pm25_obs_improve))$diff)
combined_data <- combined_data %>% mutate(pm25_obs = mean(pm25_obs_epa, pm25_obs_improve, na.rm=TRUE))
combined_data$pm25_obs = mean(combined_data$pm25_obs_epa, combined_data$pm25_obs_improve, na.rm=TRUE))
combined_data$pm25_obs = mean(combined_data$pm25_obs_epa, combined_data$pm25_obs_improve, na.rm=TRUE)
combined_data$pm25_obs = mean(combined_data$pm25_obs_epa, combined_data$pm25_obs_improve)
combined_data$pm25_obs <- 0
combined_data$pm25_obs = mean(combined_data$pm25_obs_epa, combined_data$pm25_obs_improve)
combined_data$pm25_obs_epa
combined_data$pm25_obs_improve
length(combined_data$pm25_obs_improve)
length(combined_data$pm25_obs_epa)
mean(combined_data$pm25_obs_epa, combined_data$pm25_obs_improve)
pmean(combined_data$pm25_obs_epa, combined_data$pm25_obs_improve)
combined_data$pm25_obs = rowMeans(combined_data$pm25_obs_epa, combined_data$pm25_obs_improve)
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(pm25_obs_epa, pm25_obs_improve, na.rm=TRUE))
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(c(pm25_obs_epa, pm25_obs_improve), na.rm=TRUE))
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(3:4))
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(combined_data[,3:4]))
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(combined_data[,3:4], na.rm = TRUE))
View(combined_data)
visna(combined_data)
combined_data <- combined_data %>% select(Date, uid, pm25_obs)
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
# Read in Improve and clean
improve <- readRDS("improve_data/improve_clean.rds")
# Combine one year
year <- 2016
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
combined_data$source <- ""
combined_data$source[!is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Both"
combined_data$source[!is.na(combined_data$pm25_obs_epa) & is.na(combined_data$pm25_obs_improve)] <- "EPA"
combined_data$source[is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Improve"
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(combined_data[,3:4], na.rm = TRUE))
combined_data <- combined_data %>% select(Date, uid, source, pm25_obs)
combined_data %>% group_by(Date, uid, source) %>% summarise(n=n())
combined_data %>% group_by(source) %>% summarise(n=n())
epa_info <- epa_year %>% select(uid, Latitude, Longitude, State.Code, County.Code)
substr(23009, 1,2)
substr(23009, 3,5)
epa_info <- epa_year %>% select(uid, Latitude, Longitude, State.Code, County.Code)
improve_info <- improve_year %>% select(Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS)
improve_info <- improve_year %>% select(uid, Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS)
epa_info <- epa_year %>% select(uid, Latitude, Longitude, State.Code, County.Code) %>% unique()
improve_info <- improve_year %>% select(uid, Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS) %>% unique()
length(unique(epa_info$uid))
length(unique(improve_infoo$uid))
length(unique(improve_info$uid))
combined_info <- rbind(epa_info, improve_info)
View(epa_info)
View(combined_info %>% arrange(uid))
improve_info <- improve_year %>% select(uid, Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS) %>% unique() %>% mutate(source="Improve")
View(improve_info)
combined_info <- rbind(epa_info, improve_info) %>% arrange(uid, souce)
combined_info <- rbind(epa_info, improve_info) %>% arrange(uid, source)
combined_info <- rbind(epa_info, improve_info)
epa_info <- epa_year %>% select(uid, Latitude, Longitude, State.Code, County.Code) %>% unique() %>% mutate(source="EPA")
improve_info <- improve_year %>% select(uid, Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS) %>% unique() %>% mutate(source="Improve")
combined_info <- rbind(epa_info, improve_info)
combined_info <- combined_info %>% arrange(uid, source)
View(combined_info)
combined_info %>% group_by(uid) %>% summarise(n=n()) %>% arrange(-n)
combined_info <- combined_info %>% unique(uid)
distinct
?distinct
combined_info <- combined_info %>% distinct(uid)
View(combined_info)
combined_info <- rbind(epa_info, improve_info)
combined_info <- combined_info %>% arrange(uid, source)
View(combined_info)
combined_info_dd <- combined_info %>% select(-source) %>% unique()
View(combined_info_dd)
combined_info_dd <- combined_info %>% distinct(uid, .keep_all = TRUE)
View(combined_info_dd)
View(combined_info)
combined_info <- combined_info %>% distinct(uid, .keep_all = TRUE)
combined_data <- combined_data %>% left_join(combined_info)
combined_data <- combined_data %>% left_join(combined_info, c("uid"="uid"))
View(combined_data)
# Read in Improve and clean
improve <- readRDS("improve_data/improve_clean.rds")
# Combine one year
year <- 2016
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
combined_data$source <- ""
combined_data$source[!is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Both"
combined_data$source[!is.na(combined_data$pm25_obs_epa) & is.na(combined_data$pm25_obs_improve)] <- "EPA"
combined_data$source[is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Improve"
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(combined_data[,3:4], na.rm = TRUE))
combined_data <- combined_data %>% select(Date, uid, source, pm25_obs)
epa_info <- epa_year %>% select(uid, Latitude, Longitude, State.Code, County.Code) %>% unique() %>% mutate(source="EPA")
improve_info <- improve_year %>% select(uid, Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS) %>% unique() %>% mutate(source="Improve")
combined_info <- rbind(epa_info, improve_info)
combined_info <- combined_info %>% arrange(uid, source)
combined_info <- combined_info %>% distinct(uid, .keep_all = TRUE)
combined_year <- combined_data %>% left_join(combined_info, c("uid"="uid"))
View(combined_year)
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
# Read in Improve and clean
improve <- readRDS("improve_data/improve_clean.rds")
# Combine one year
year <- 2016
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
combined_data$source <- ""
combined_data$source[!is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Both"
combined_data$source[!is.na(combined_data$pm25_obs_epa) & is.na(combined_data$pm25_obs_improve)] <- "EPA"
combined_data$source[is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Improve"
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(combined_data[,3:4], na.rm = TRUE))
combined_data <- combined_data %>% select(Date, uid, source, pm25_obs)
epa_info <- epa_year %>% select(uid, Latitude, Longitude, State.Code, County.Code) %>% unique() %>% mutate(source="EPA")
improve_info <- improve_year %>% select(uid, Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS) %>% unique() %>% mutate(source="Improve")
combined_info <- rbind(epa_info, improve_info)
combined_info <- combined_info %>% arrange(uid, source)
combined_info <- combined_info %>% distinct(uid, .keep_all = TRUE) %>% select(-source)
combined_year <- combined_data %>% left_join(combined_info, c("uid"="uid"))
View(combined_year)
View(epa_year)
View(epa_year %>% filter(source=="Improve"))
View(combined_year %>% filter(source=="Improve"))
View(improve)
View(improve_year)
View(epa_year %?% filter(uid=="230090103"))
View(epa_year %>% filter(uid=="230090103"))
(1.38909 + 1.8)/2
View(combined_year %>% filter(uid=="230090103"))
View(combined_year %>% filter(uid=="230090103") %>% arrange(Date))
nrow(combined_year %>% select(uid, Date) %>% unique())==nrow(combined_year)
savefile = paste0("combined/epa_improve_", year, ".rds")
saveRDS(savefile)
savefile
saveRDS(combined_year, file=savefile)
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
# Read in Improve and clean
improve <- readRDS("improve_data/improve_clean.rds")
# Combine one year
year <- 2015
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
combined_data$source <- ""
combined_data$source[!is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Both"
combined_data$source[!is.na(combined_data$pm25_obs_epa) & is.na(combined_data$pm25_obs_improve)] <- "EPA"
combined_data$source[is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Improve"
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(combined_data[,3:4], na.rm = TRUE))
combined_data <- combined_data %>% select(Date, uid, source, pm25_obs)
epa_info <- epa_year %>% select(uid, Latitude, Longitude, State.Code, County.Code) %>% unique() %>% mutate(source="EPA")
improve_info <- improve_year %>% select(uid, Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS) %>% unique() %>% mutate(source="Improve")
combined_info <- rbind(epa_info, improve_info)
combined_info <- combined_info %>% arrange(uid, source)
combined_info <- combined_info %>% distinct(uid, .keep_all = TRUE) %>% select(-source)
combined_year <- combined_data %>% left_join(combined_info, c("uid"="uid"))
if(!(nrow(combined_year %>% select(uid, Date) %>% unique())==nrow(combined_year))){
print("Not unique")
}
savefile = paste0("combined/epa_improve_", year, ".rds")
saveRDS(combined_year, file=savefile)
View(combined_year)
View(combined_year %>% filter(source=="Both"))
View(combined_year %>% filter(uid=="010730023"))
combined_year <- combined_year %>% arrange(uid, Date)
View(combined_year %>% filter(uid=="010730023"))
View(epa_year)
View(improve_year)
View(epa_year %>% filter(uid=="010730023"))
View(improve_year %>% filter(uid=="010730023"))
nrow(combined_year %>% select(uid, Date) %>% unique())==nrow(combined_year)
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
# Read in Improve and clean
improve <- readRDS("improve_data/improve_clean.rds")
# Combine one year
year <- 2000:2016
for(year in years){
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
combined_data$source <- ""
combined_data$source[!is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Both"
combined_data$source[!is.na(combined_data$pm25_obs_epa) & is.na(combined_data$pm25_obs_improve)] <- "EPA"
combined_data$source[is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Improve"
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(combined_data[,3:4], na.rm = TRUE))
combined_data <- combined_data %>% select(Date, uid, source, pm25_obs)
epa_info <- epa_year %>% select(uid, Latitude, Longitude, State.Code, County.Code) %>% unique() %>% mutate(source="EPA")
improve_info <- improve_year %>% select(uid, Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS) %>% unique() %>% mutate(source="Improve")
combined_info <- rbind(epa_info, improve_info)
combined_info <- combined_info %>% arrange(uid, source)
combined_info <- combined_info %>% distinct(uid, .keep_all = TRUE) %>% select(-source)
combined_year <- combined_data %>% left_join(combined_info, c("uid"="uid"))
if(!(nrow(combined_year %>% select(uid, Date) %>% unique())==nrow(combined_year))){
print("Not unique")
}
combined_year <- combined_year %>% arrange(uid, Date)
savefile = paste0("combined/epa_improve_", year, ".rds")
saveRDS(combined_year, file=savefile)
}
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
# Read in Improve and clean
improve <- readRDS("improve_data/improve_clean.rds")
# Combine one year
years <- 2000:2016
for(year in years){
epa_year <- readRDS(paste0("epa_data/Deduped/epa_deduped_", year, ".rds"))
improve_year <- improve %>% filter(year(Date) == year)
epa_year_data <- epa_year %>% select(uid, Date, pm25_obs)
improve_year_data <- improve_year %>% select(uid, Date, pm25_obs)
combined_data <- epa_year_data %>% full_join(improve_year_data,
c("uid"="uid", "Date"="Date"),
suffix = c("_epa", "_improve"))
combined_data$source <- ""
combined_data$source[!is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Both"
combined_data$source[!is.na(combined_data$pm25_obs_epa) & is.na(combined_data$pm25_obs_improve)] <- "EPA"
combined_data$source[is.na(combined_data$pm25_obs_epa) & !is.na(combined_data$pm25_obs_improve)] <- "Improve"
combined_data <- combined_data %>% mutate(pm25_obs = rowMeans(combined_data[,3:4], na.rm = TRUE))
combined_data <- combined_data %>% select(Date, uid, source, pm25_obs)
epa_info <- epa_year %>% select(uid, Latitude, Longitude, State.Code, County.Code) %>% unique() %>% mutate(source="EPA")
improve_info <- improve_year %>% select(uid, Latitude, Longitude, CountyFIPS) %>%
mutate(State.Code = substr(CountyFIPS, 1, 2), County.Code = substr(CountyFIPS, 3, 5)) %>%
select(-CountyFIPS) %>% unique() %>% mutate(source="Improve")
combined_info <- rbind(epa_info, improve_info)
combined_info <- combined_info %>% arrange(uid, source)
combined_info <- combined_info %>% distinct(uid, .keep_all = TRUE) %>% select(-source)
combined_year <- combined_data %>% left_join(combined_info, c("uid"="uid"))
if(!(nrow(combined_year %>% select(uid, Date) %>% unique())==nrow(combined_year))){
print("Not unique")
}
combined_year <- combined_year %>% arrange(uid, Date)
savefile = paste0("combined/epa_improve_", year, ".rds")
saveRDS(combined_year, file=savefile)
}
years <- 2000:2016
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
years <- 2000:2016
data_all <- readRDS(paste0("combined/epa_improve_",years[1],".rds"))
for(year in years){
year_data <- readRDS(paste0("combined/epa_improve_",year,".rds"))
data_all <- rbind(data_all, year_data)
}
nrow(data_all)==nrow(data_all %>% select(uid, Date) %>% unique())
nrow(data_all)
nrow(data_all %>% select(uid, Date) %>% unique())
nrow(data_all)-nrow(data_all %>% select(uid, Date) %>% unique())
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
years <- 2000:2016
data_all <- readRDS(paste0("combined/epa_improve_",years[1],".rds"))
for(year in years[2:length(years)]){
year_data <- readRDS(paste0("combined/epa_improve_",year,".rds"))
data_all <- rbind(data_all, year_data)
}
nrow(data_all)-nrow(data_all %>% select(uid, Date) %>% unique())
setwd("/Users/hammaadadam/Desktop/Columbia/Courses/Capstone/CapstoneProject/Data/")
library(tidyverse)
library(lubridate)
library(extracat)
years <- 2000:2016
data_all <- readRDS(paste0("combined/epa_improve_",years[1],".rds"))
for(year in years[2:length(years)]){
year_data <- readRDS(paste0("combined/epa_improve_",year,".rds"))
data_all <- rbind(data_all, year_data)
}
nrow(data_all)==nrow(data_all %>% select(uid, Date) %>% unique())
saveRDS("pm25_observed_2000_2016")
saveRDS(data_all, file="pm25_observed_2000_2016")
range(data_all$Date)
saveRDS(data_all, file="pm25_observed_2000_2016.rds")
